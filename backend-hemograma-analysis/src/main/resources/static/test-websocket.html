<!DOCTYPE html>
<html>
<head>
    <title>Sistema de Notifica√ß√µes em Tempo Real</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h1>üîî Notifica√ß√µes em Tempo Real - HIV</h1>

<div>
    <button onclick="conectarWebSocket()">‚ñ∂Ô∏è Conectar</button>
    <button onclick="desconectarWebSocket()">‚èπÔ∏è Desconectar</button>
    <button onclick="limparNotificacoes()">üóëÔ∏è Limpar</button>
    <span id="status" style="margin-left: 20px; padding: 5px 10px; background: #f0f0f0;"></span>
</div>

<div style="display: flex; margin-top: 20px;">
    <div style="flex: 1;">
        <h3>üìä Estat√≠sticas</h3>
        <div id="estatisticas" style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            Aguardando conex√£o...
        </div>
    </div>

    <div style="flex: 2; margin-left: 20px;">
        <h3>üîî Notifica√ß√µes em Tempo Real</h3>
        <div id="notificacoes" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fff;"></div>
    </div>
</div>

<script>
    let stompClient = null;
    let notificacoesCount = 0;

    function conectarWebSocket() {
        const socket = new SockJS('http://localhost:8080/ws-notificacoes');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            atualizarStatus('‚úÖ CONECTADO', '#d4edda');

            // üî• INSCREVE PARA RECEBER NOTIFICA√á√ïES EM TEMPO REAL
            stompClient.subscribe('/topic/notificacoes-tempo-real', function(mensagem) {
                const data = JSON.parse(mensagem.body);
                adicionarNotificacaoTempoReal(data);
            });

            // Inscreve para estat√≠sticas em tempo real
            stompClient.subscribe('/topic/estatisticas-tempo-real', function(mensagem) {
                const data = JSON.parse(mensagem.body);
                atualizarEstatisticas(data);
            });

            // Solicita notifica√ß√µes iniciais
            stompClient.subscribe('/user/queue/notificacoes.iniciais', function(mensagem) {
                const data = JSON.parse(mensagem.body);
                carregarNotificacoesIniciais(data);
            });

            // Solicita estat√≠sticas atuais
            stompClient.send("/app/estatisticas.atual", {});

        }, function(error) {
            atualizarStatus('‚ùå ERRO: ' + error, '#f8d7da');
            console.error('Erro WebSocket:', error);
        });
    }

    function desconectarWebSocket() {
        if (stompClient !== null) {
            stompClient.disconnect();
            atualizarStatus('üî¥ DESCONECTADO', '#f0f0f0');
        }
    }

    function adicionarNotificacaoTempoReal(data) {
        notificacoesCount++;
        const notificacoesDiv = document.getElementById('notificacoes');

        const notificacaoElement = document.createElement('div');
        notificacaoElement.style.cssText = `
                padding: 10px;
                margin: 5px 0;
                border-left: 4px solid #dc3545;
                background: #fff3f3;
                border-radius: 4px;
                animation: fadeIn 0.5s;
            `;

        const notificacaoData = data.data;
        notificacaoElement.innerHTML = `
                <strong>üö® ${notificacaoData.tipo || 'NOVA NOTIFICA√á√ÉO'}</strong>
                <br><small>üìÖ ${new Date().toLocaleTimeString()}</small>
                <br>üë§ Paciente: ${notificacaoData.pacienteId || 'N/A'}
                <br>üìç Regi√£o: ${notificacaoData.regiao || 'N/A'} - ${notificacaoData.estado || 'N/A'}
                <br>üéØ Motivo: ${notificacaoData.motivoRisco || 'Risco HIV detectado'}
                <br><em>${data.mensagem}</em>
            `;

        // Adiciona no topo
        notificacoesDiv.insertBefore(notificacaoElement, notificacoesDiv.firstChild);

        // Atualiza estat√≠sticas
        stompClient.send("/app/estatisticas.atual", {});

        // üîî Notifica√ß√£o do navegador (se suportado)
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification("Nova Notifica√ß√£o HIV", {
                body: `Paciente ${notificacaoData.pacienteId} - ${notificacaoData.regiao}`,
                icon: "/notification-icon.png"
            });
        }

        console.log('Nova notifica√ß√£o em tempo real:', data);
    }

    function carregarNotificacoesIniciais(data) {
        const notificacoesDiv = document.getElementById('notificacoes');

        if (data.data && data.data.length > 0) {
            data.data.forEach(notificacao => {
                const element = document.createElement('div');
                element.style.cssText = `
                        padding: 8px;
                        margin: 3px 0;
                        border-left: 4px solid #6c757d;
                        background: #f8f9fa;
                        border-radius: 4px;
                    `;

                element.innerHTML = `
                        <strong>üìã ${notificacao.tipo}</strong>
                        <br><small>üìç ${notificacao.regiao} - ${notificacao.estado}</small>
                        <br><small>üë§ ${notificacao.pacienteId}</small>
                    `;

                notificacoesDiv.appendChild(element);
            });
        }
    }

    function atualizarEstatisticas(data) {
        const estatisticasDiv = document.getElementById('estatisticas');
        estatisticasDiv.innerHTML = `
                <div><strong>Total de Notifica√ß√µes:</strong> ${data.totalNotificacoes || 0}</div>
                <div><strong>N√£o Lidas:</strong> ${data.naoLidas || 0}</div>
                <div><strong>Lidas:</strong> ${data.lidas || 0}</div>
                <div><strong>Atualizado:</strong> ${new Date().toLocaleTimeString()}</div>
            `;
    }

    function atualizarStatus(mensagem, cor) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = mensagem;
        statusDiv.style.background = cor;
    }

    function limparNotificacoes() {
        document.getElementById('notificacoes').innerHTML = '';
        notificacoesCount = 0;
    }

    // Solicitar permiss√£o para notifica√ß√µes do navegador
    if ("Notification" in window) {
        Notification.requestPermission();
    }

    // Conectar automaticamente ao carregar a p√°gina
    window.onload = conectarWebSocket;

    // Estilo para anima√ß√£o
    const style = document.createElement('style');
    style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
    document.head.appendChild(style);
</script>
</body>
</html>